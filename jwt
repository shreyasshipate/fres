@GetMapping("/media/download/{id}")
public ResponseEntity<byte[]> downloadImage(@PathVariable int id) {

    ImageFile image = imageRepo.findById(id).orElse(null);
    if (image == null) {
        return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body("File not found".getBytes());
    }

    // Logged-in user
    String email = SecurityContextHolder.getContext().getAuthentication().getName();
    UserInfo loggedUser = userRepo.findByEmail(email);

    // ❌ If not owner → send 403
    if (image.getUser().getId() != loggedUser.getId()) {
        return ResponseEntity.status(HttpStatus.FORBIDDEN)
                .body("Unauthorized".getBytes());
    }

    try {
        Path path = Paths.get(image.getPath());
        byte[] bytes = Files.readAllBytes(path);

        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION,
                        "attachment; filename=" + image.getFileName())
                .body(bytes);

    } catch (Exception e) {
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body("Error reading file".getBytes());
    }
}
