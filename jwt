@RestController
public class Controller {

    @Autowired
    private AuthenticationManager authenticationManager;

    @Autowired
    private UserInfoRepository userRepo;

    @Autowired
    private ImageRepository imageRepo;

    @Autowired
    private JwtUtils jwtUtils;

    private final String uploadDir = "src/main/resources/uploads";

    // ---------------------- LOGIN ----------------------
    @PostMapping("/login")
    public ResponseEntity<?> authenticateAndGetToken(@RequestBody AuthRequest authRequest) {

        Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                        authRequest.getEmail(),
                        authRequest.getPassword()
                )
        );

        if (authentication.isAuthenticated()) {
            String token = jwtUtils.generateToken(authRequest.getEmail());
            return ResponseEntity.ok(Map.of("token", token));
        }

        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Invalid credentials");
    }

    // ---------------------- UPLOAD ----------------------
    @PostMapping("/media/upload")
    public ResponseEntity<ImageFile> uploadImage(@RequestParam("file") MultipartFile file) {

        // Create upload directory if not exists
        File dir = new File(uploadDir);
        if (!dir.exists()) dir.mkdirs();

        // Build actual file path
        String filePath = uploadDir + "/" + file.getOriginalFilename();

        try {
            // Save file to disk
            file.transferTo(new File(filePath));
        } catch (Exception ex) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
        }

        // Logged-in user
        String email = SecurityContextHolder.getContext().getAuthentication().getName();
        UserInfo user = userRepo.findByEmail(email);

        // Save file metadata to DB
        ImageFile img = new ImageFile(
                file.getOriginalFilename(),
                file.getContentType(),
                filePath
        );
        img.setUser(user);

        ImageFile saved = imageRepo.save(img);

        return ResponseEntity.ok(saved);
    }

    // ---------------------- DOWNLOAD ----------------------
    @GetMapping("/media/download/{id}")
    public byte[] downloadImage(@PathVariable int id) {

        ImageFile image = imageRepo.findById(id).orElse(null);
        if (image == null) {
            return "Error Occurred".getBytes();
        }

        // Logged-in user
        String email = SecurityContextHolder.getContext().getAuthentication().getName();
        UserInfo loggedUser = userRepo.findByEmail(email);

        // Only owner can download
        if (image.getUser().getId() != loggedUser.getId()) {
            return "Error Occurred".getBytes();
        }

        try {
            Path path = Paths.get(image.getPath());
            return Files.readAllBytes(path);
        } catch (Exception e) {
            return "Error Occurred".getBytes();
        }
    }
}
