@PostMapping("/media/upload")
public ResponseEntity<ImageFile> uploadImage(@RequestParam("file") MultipartFile file,
                                             @AuthenticationPrincipal UserInfo user) {
    try {
        File dir = new File(uploadDir);
        if (!dir.exists()) dir.mkdirs();

        String fileName = file.getOriginalFilename();
        String filePath = uploadDir + "/" + fileName;

        // Save the file to local folder
        File newFile = new File(filePath);
        file.transferTo(newFile);

        // Save record in DB
        ImageFile image = new ImageFile(fileName, file.getContentType(), filePath);
        image.setUser(user);                          // IMPORTANT â†’ fixes your JSON error
        ImageFile saved = imageRepo.save(image);

        return ResponseEntity.ok(saved);

    } catch (Exception ex) {
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
    }
}



@GetMapping("/media/download/{id}")
public byte[] downloadImage(@PathVariable int id,
                            @AuthenticationPrincipal UserInfo user) {

    ImageFile image = imageRepo.findById(id).orElse(null);

    if (image == null) {
        return "Error Occurred".getBytes();
    }

    // user must be the owner
    if (image.getUser() == null || image.getUser().getId() != user.getId()) {
        return "Error Occurred".getBytes();
    }

    try {
        Path path = Paths.get(image.getPath());
        return Files.readAllBytes(path);
    } catch (Exception ex) {
        return "Error Occurred".getBytes();
    }
}
